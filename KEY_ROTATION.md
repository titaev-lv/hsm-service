# –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ —Ä–æ—Ç–∞—Ü–∏–∏ KEK

## –û–±–∑–æ—Ä

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ–¥—É—Ä—É —Ä–æ—Ç–∞—Ü–∏–∏ KEK (Key Encryption Key) –¥–ª—è HSM Service. –†–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π ‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, —Ç—Ä–µ–±—É–µ–º–∞—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–º PCI DSS Requirement 3.6.4.

## üî• Zero-Downtime Rotation (Phase 4+)

**–° –≤–µ—Ä—Å–∏–∏ Phase 4 HSM service –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é hot reload** –∫–ª—é—á–µ–π –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–∏—Å–∞.

### –î–æ Phase 4 (—Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–±)
```bash
hsm-admin rotate exchange-key
docker compose restart hsm-service  # ‚ùå DOWNTIME –¥–ª—è –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤!
```

### –ü–æ—Å–ª–µ Phase 4 (—Ç–µ–∫—É—â–∏–π —Å–ø–æ—Å–æ–±)
```bash
hsm-admin rotate exchange-key
# ‚úÖ –°–µ—Ä–≤–∏—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç KEK –≤ —Ç–µ—á–µ–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥
# ‚úÖ ZERO DOWNTIME - –≤—Å–µ –∫–ª–∏–µ–Ω—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º–∏
```

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. **Background monitor** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `metadata.yaml` –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
2. **–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ?** ‚Üí –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
3. **–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–µ KEKs** –∏–∑ HSM (—á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é PKCS#11 —Å–µ—Å—Å–∏—é)
4. **Atomic swap** - –≤—Å–µ –∫–ª—é—á–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
5. **–°—Ç–∞—Ä—ã–µ –∫–ª—é—á–∏** –æ—Å—Ç–∞—é—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ hot reload:**
```bash
# –ù–∞–±–ª—é–¥–∞—Ç—å –∑–∞ —Å–æ–±—ã—Ç–∏—è–º–∏ reload
docker compose logs -f hsm-service | grep "reload"

# –£—Å–ø–µ—à–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞:
# {"level":"INFO","msg":"KEK hot reload successful","contexts":2,"total_keys":3}

# –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ (—Å—Ç–∞—Ä—ã–µ –∫–ª—é—á–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã):
# {"level":"WARN","msg":"metadata reload failed - keeping old keys"}
```

## –ü–æ–ª–∏—Ç–∏–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏

- **–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**: 90 –¥–Ω–µ–π (2160 —á–∞—Å–æ–≤)
- **–ü–µ—Ä–∏–æ–¥ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è**: 7 –¥–Ω–µ–π (–æ–±–∞ –∫–ª—é—á–∞ - —Å—Ç–∞—Ä—ã–π –∏ –Ω–æ–≤—ã–π - —Ä–∞–±–æ—Ç–∞—é—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)
- **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ö–ª—é—á–∏ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä—É—é—Ç—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, kek-exchange-v1 ‚Üí kek-exchange-v2)

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ —Ä–æ—Ç–∞—Ü–∏–∏

–°–µ—Ä–≤–∏—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–ª—é—á–∏, —Ç—Ä–µ–±—É—é—â–∏–µ —Ä–æ—Ç–∞—Ü–∏–∏, –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ. –ï—Å–ª–∏ –∫–∞–∫–∏–µ-–ª–∏–±–æ –∫–ª—é—á–∏ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω—ã, –≤ –ª–æ–≥–∞—Ö –ø–æ—è–≤—è—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:

```
‚ö†Ô∏è  WARNING: The following keys need rotation:
  - kek-exchange-v1 (created: 2025-10-10, rotation interval: 2160h0m0s, version: 1)
‚ö†Ô∏è  Run 'hsm-admin rotation-status' to check all keys
‚ö†Ô∏è  Run 'hsm-admin rotate <label>' to rotate keys
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ä–æ—Ç–∞—Ü–∏–∏

–ß—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ä–æ—Ç–∞—Ü–∏–∏ –≤—Å–µ—Ö –∫–ª—é—á–µ–π:

```bash
hsm-admin rotation-status
```

–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
```
Key Rotation Status:
====================

‚úì Context: exchange-key
  Label:             kek-exchange-v1
  Version:           1
  Created:           2026-01-09 10:30:00
  Rotation Interval: 2160h0m0s
  Next Rotation:     2026-04-09
  Status:            OK (89 days remaining)

‚ö†Ô∏è  Context: 2fa
  Label:             kek-2fa-v1
  Version:           1
  Created:           2025-10-10 10:30:00
  Rotation Interval: 2160h0m0s
  Next Rotation:     2026-01-08
  Status:            NEEDS ROTATION (1 days overdue)
```

## –®–∞–≥–∏ —Ä—É—á–Ω–æ–π —Ä–æ—Ç–∞—Ü–∏–∏

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–π, —Ç—Ä–µ–±—É—é—â–∏—Ö —Ä–æ—Ç–∞—Ü–∏–∏

```bash
docker exec hsm-service /app/hsm-admin rotation-status
```

### –®–∞–≥ 2: –†–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–∞

```bash
docker exec hsm-service /app/hsm-admin rotate kek-exchange-v1
```

–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç:
1. –†–∞–∑–±–æ—Ä –º–µ—Ç–∫–∏ –∫–ª—é—á–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –±–∞–∑–æ–≤–æ–≥–æ –∏–º–µ–Ω–∏ –∏ –≤–µ—Ä—Å–∏–∏
2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—é –Ω–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –≤–µ—Ä—Å–∏–∏ (v1 ‚Üí v2)
3. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ KEK —Å –º–µ—Ç–∫–æ–π `kek-exchange-v2`
4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `config.yaml` —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –Ω–æ–≤–æ–º –∫–ª—é—á–µ
5. –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞ (`config.yaml.backup-TIMESTAMP`)

–ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
```
Creating new KEK: kek-exchange-v2
‚úì Created KEK: kek-exchange-v2 (handle: 3, ID: 02, version: 2, created: 2026-01-09T14:30:00Z)
Created config backup: config.yaml.backup-20260109-143000
‚úì Key rotation completed:
  Old key: kek-exchange-v1 (version 1)
  New key: kek-exchange-v2 (version 2)

‚ö†Ô∏è  IMPORTANT:
  1. Wait 30 seconds for automatic hot reload (NO RESTART NEEDED)
  2. Re-encrypt all data encrypted with the old key  
  3. After 7 days overlap period, delete the old key:
     hsm-admin cleanup exchange-key --version 1
```

### –®–∞–≥ 3: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è Hot Reload (Zero-Downtime)

**‚úÖ –í–ê–ñ–ù–û**: –° –≤–µ—Ä—Å–∏–∏ Phase 4 —Å–µ—Ä–≤–∏—Å **–ù–ï —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏** –ø–æ—Å–ª–µ —Ä–æ—Ç–∞—Ü–∏–∏ –∫–ª—é—á–µ–π!

HSM service –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç metadata.yaml –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –±–µ–∑ downtime.

```bash
# ‚ùå –°–¢–ê–†–´–ô –°–ü–û–°–û–ë (–¥–æ Phase 4):
docker compose restart hsm-service  # Downtime –¥–ª—è –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤!

# ‚úÖ –ù–û–í–´–ô –°–ü–û–°–û–ë (Phase 4+):
# –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å - —Å–µ—Ä–≤–∏—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç KEK –≤ —Ç–µ—á–µ–Ω–∏–µ 30 —Å–µ–∫—É–Ω–¥
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π hot reload (30 —Å–µ–∫—É–Ω–¥)..."
sleep 35

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
docker compose logs --since 40s hsm-service | grep "KEK hot reload"
```

Expected output:
```
{"time":"2026-01-10T20:00:15Z","level":"INFO","msg":"metadata file changed","path":"/app/metadata.yaml"}
{"time":"2026-01-10T20:00:15Z","level":"INFO","msg":"KEK hot reload successful","contexts":2,"total_keys":3}
```

Verify new key is active:
```bash
curl -sk https://localhost:8443/health | jq
```

**Benefits of hot reload:**
- ‚úÖ Zero downtime for 50+ connected clients
- ‚úÖ No active request interruptions
- ‚úÖ Automatic detection of metadata changes
- ‚úÖ Old keys remain available for decryption

**Note:** If you need immediate reload (< 30s), restart is still supported:
```bash
docker compose restart hsm-service  # Forces immediate reload
```

–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:
```json
{
  "status": "healthy",
  "hsm_available": true,
  "kek_status": {
    "kek-2fa-v1": "available",
    "kek-exchange-v1": "available",
    "kek-exchange-v2": "available"
  }
}
```

### –®–∞–≥ 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

–û–±–Ω–æ–≤–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ –∫–ª—é—á–∞. –í —Ç–µ—á–µ–Ω–∏–µ 7-–¥–Ω–µ–≤–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –æ–±–∞ –∫–ª—é—á–∞ - —Å—Ç–∞—Ä—ã–π –∏ –Ω–æ–≤—ã–π.

–¢–µ—Å—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å –Ω–æ–≤—ã–º –∫–ª—é—á–æ–º:
```bash
curl -sk -X POST https://localhost:8443/encrypt \
  --cert pki/client/hsm-trading-client-1.crt \
  --key pki/client/hsm-trading-client-1.key \
  --cacert pki/ca/ca.crt \
  -H 'Content-Type: application/json' \
  -d '{"context":"exchange-key","plaintext":"VGVzdA=="}'
```

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á:
```json
{
  "ciphertext": "...",
  "key_id": "kek-exchange-v2"
}
```

### –®–∞–≥ 5: –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ, –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ä—ã–º –∫–ª—é—á–æ–º. –≠—Ç–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —Å–ø–æ—Å–æ–±–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:

**–ü—Ä–∏–º–µ—Ä –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:**
```sql
-- –ü—Å–µ–≤–¥–æ–∫–æ–¥ - –∞–¥–∞–ø—Ç–∏—Ä—É–π—Ç–µ –ø–æ–¥ –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
UPDATE encrypted_data
SET 
  ciphertext = encrypt_with_new_key(decrypt_with_old_key(ciphertext)),
  key_version = 2
WHERE key_version = 1;
```

**–ü—Ä–∏–º–µ—Ä —Å–∫—Ä–∏–ø—Ç–∞:**
```bash
#!/bin/bash
# –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —Å v1 –Ω–∞ v2

for record in $(get_all_encrypted_records); do
  # –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã–º –∫–ª—é—á–æ–º
  plaintext=$(curl -X POST https://localhost:8443/decrypt \
    --cert client.crt --key client.key --cacert ca.crt \
    -d "{\"context\":\"exchange-key\",\"ciphertext\":\"$record\",\"key_id\":\"kek-exchange-v1\"}")
  
  # –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã–º –∫–ª—é—á–æ–º
  new_ciphertext=$(curl -X POST https://localhost:8443/encrypt \
    --cert client.crt --key client.key --cacert ca.crt \
    -d "{\"context\":\"exchange-key\",\"plaintext\":\"$plaintext\"}")
  
  # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î
  update_record "$record_id" "$new_ciphertext" "kek-exchange-v2"
done
```

### –®–∞–≥ 6: –ü–µ—Ä–∏–æ–¥ –æ–∂–∏–¥–∞–Ω–∏—è (7 –¥–Ω–µ–π)

–í —Ç–µ—á–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞:
- –î–æ—Å—Ç—É–ø–Ω—ã –æ–±–∞ –∫–ª—é—á–∞ - —Å—Ç–∞—Ä—ã–π –∏ –Ω–æ–≤—ã–π
- –ù–æ–≤—ã–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–æ–≤—ã–π –∫–ª—é—á
- –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –≤—Å–µ –µ—â–µ –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–º –∫–ª—é—á–æ–º
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º

### –®–∞–≥ 7: –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∫–ª—é—á–∞

–ü–æ—Å–ª–µ –ø–µ—Ä–∏–æ–¥–∞ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã:

```bash
docker exec hsm-service /app/hsm-admin delete-kek --label kek-exchange-v1 --confirm
```

–ü—Ä–æ–≤–µ—Ä–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:
```bash
docker exec hsm-service /app/hsm-admin list-kek
```

## –§–æ—Ä–º–∞—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞

–ö–ª—é—á–∏ –≤ `config.yaml` —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞—é—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ä–æ—Ç–∞—Ü–∏–∏:

```yaml
hsm:
  pkcs11_lib: /usr/lib/softhsm/libsofthsm2.so
  slot_id: hsm-token
  keys:
    exchange-key:
      label: kek-exchange-v2
      type: aes
      rotation_interval: 2160h  # 90 –¥–Ω–µ–π
      version: 2
      created_at: 2026-01-09T14:30:00Z
    2fa:
      label: kek-2fa-v1
      type: aes
      rotation_interval: 2160h  # 90 –¥–Ω–µ–π
      version: 1
      created_at: 2026-01-09T10:30:00Z
```

## –°–æ–≥–ª–∞—à–µ–Ω–∏–µ –æ–± –∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏ –∫–ª—é—á–µ–π

–ö–ª—é—á–∏ –¥–æ–ª–∂–Ω—ã —Å–ª–µ–¥–æ–≤–∞—Ç—å —ç—Ç–æ–º—É —à–∞–±–ª–æ–Ω—É –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è:
```
<–±–∞–∑–æ–≤–æ–µ-–∏–º—è>-v<–≤–µ—Ä—Å–∏—è>

–ü—Ä–∏–º–µ—Ä—ã:
  kek-exchange-v1
  kek-exchange-v2
  kek-2fa-v1
  kek-payment-v1
```

## –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è

–ï—Å–ª–∏ –∫–ª—é—á —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—É—é —Ä–æ—Ç–∞—Ü–∏—é:

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Ä–æ—Ç–∏—Ä—É–π—Ç–µ –∫–ª—é—á** (–ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ –æ–±—ã—á–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –æ–∂–∏–¥–∞–Ω–∏—è)
2. **–û—Ç–∑–æ–≤–∏—Ç–µ –¥–æ—Å—Ç—É–ø** –∫ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –∫–ª—é—á—É
3. **–ü–µ—Ä–µ—à–∏—Ñ—Ä—É–π—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ** –Ω–æ–≤—ã–º –∫–ª—é—á–æ–º (–Ω–µ –∂–¥–∏—Ç–µ –ø–µ—Ä–∏–æ–¥–∞ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è)
4. **–£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–π –∫–ª—é—á** –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
5. **–ü—Ä–æ–≤–µ–¥–∏—Ç–µ –∞—É–¥–∏—Ç –≤—Å–µ—Ö –ª–æ–≥–æ–≤ –¥–æ—Å—Ç—É–ø–∞** –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
6. **–£–≤–µ–¥–æ–º–∏—Ç–µ —Å–ª—É–∂–±—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏** –∏ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã—Ö –ª–∏—Ü

```bash
# –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è
docker exec hsm-service /app/hsm-admin rotate kek-exchange-v1
docker compose restart hsm-service
# –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∫–ª—é—á–∞ –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è
docker exec hsm-service /app/hsm-admin delete-kek --label kek-exchange-v1 --confirm
```

## –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è

–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–æ—Ç–∞—Ü–∏–∏ (cron job):

```bash
#!/bin/bash
# /etc/cron.daily/hsm-key-rotation-check

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ä–æ—Ç–∞—Ü–∏–∏
NEEDS_ROTATION=$(docker exec hsm-service /app/hsm-admin rotation-status | grep "NEEDS ROTATION" | wc -l)

if [ "$NEEDS_ROTATION" -gt 0 ]; then
  echo "–ö–ª—é—á–∏ —Ç—Ä–µ–±—É—é—Ç —Ä–æ—Ç–∞—Ü–∏–∏ - –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è"
  # –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥–µ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏
  send_alert "–ö–ª—é—á–∏ HSM —Ç—Ä–µ–±—É—é—Ç —Ä–æ—Ç–∞—Ü–∏–∏ - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä–æ—Ç–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é"
  
  # –ó–∞–ø–∏—Å—å –≤ syslog
  logger -t hsm-rotation "WARNING: –ö–ª—é—á–∏ —Ç—Ä–µ–±—É—é—Ç —Ä–æ—Ç–∞—Ü–∏–∏"
fi
```

## –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ PCI DSS

–≠—Ç–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ —Ä–æ—Ç–∞—Ü–∏–∏ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é PCI DSS Requirement 3.6.4:

- ‚úÖ **3.6.4.a**: –ö–ª—é—á–∏ —Ä–æ—Ç–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã (90 –¥–Ω–µ–π)
- ‚úÖ **3.6.4.b**: –ö–ª—é—á–∏ —Ä–æ—Ç–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏ (–ø—Ä–æ—Ü–µ–¥—É—Ä–∞ —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–π —Ä–æ—Ç–∞—Ü–∏–∏)
- ‚úÖ **3.6.4.c**: –°—Ç–∞—Ä—ã–µ –∫–ª—é—á–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –∏–∑ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏/—É–¥–∞–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–∏–æ–¥–∞ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è
- ‚úÖ **3.6.4.d**: –ù–æ–≤—ã–µ –∫–ª—é—á–∏ –∑–∞–º–µ–Ω—è—é—Ç —Å—Ç–∞—Ä—ã–µ –¥–ª—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –ü—Ä–æ–±–ª–µ–º–∞: –°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Ä–æ—Ç–∞—Ü–∏–∏

**–ü—Ä–∏—á–∏–Ω–∞**: –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏–ª–∏ –Ω–æ–≤—ã–π –∫–ª—é—á –Ω–µ —Å–æ–∑–¥–∞–Ω

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –∫–æ–Ω—Ñ–∏–≥–∞
docker exec hsm-service cat /app/config.yaml

# –°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π –≤ HSM
docker exec hsm-service pkcs11-tool --module /usr/lib/softhsm/libsofthsm2.so \
  --token-label hsm-token --list-objects --type secrkey --login --pin 1234

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
docker exec hsm-service cp /app/config.yaml.backup-TIMESTAMP /app/config.yaml
docker compose restart hsm-service
```

### –ü—Ä–æ–±–ª–µ–º–∞: –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞—é—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞**: –°—Ç–∞—Ä—ã–π –∫–ª—é—á –±—ã–ª —É–¥–∞–ª–µ–Ω –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –ø–µ—Ä–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã

**–†–µ—à–µ–Ω–∏–µ**:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Ç–æ–∫–µ–Ω–∞
2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å—Ç–∞—Ä—ã–π –∫–ª—é—á –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
3. –ó–∞–≤–µ—Ä—à–∏—Ç–µ –ø–µ—Ä–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
4. –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–π –∫–ª—é—á —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–æ–º–∞–Ω–¥–∞ —Ä–æ—Ç–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π

**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ HSM

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ HSM_PIN
docker exec hsm-service env | grep HSM_PIN

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞
docker exec hsm-service pkcs11-tool --module /usr/lib/softhsm/libsofthsm2.so \
  --token-label hsm-token --login --pin 1234 --test

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ config.yaml
docker exec hsm-service ls -la /app/config.yaml
```

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

1. **–ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ —Ä–æ—Ç–∞—Ü–∏–∏** –Ω–∞ –≤—Ä–µ–º—è –æ–∫–æ–Ω –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
2. **–î–µ–ª–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ config.yaml** –ø–µ—Ä–µ–¥ —Ä–æ—Ç–∞—Ü–∏–µ–π
3. **–î–µ–ª–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —Ç–æ–∫–µ–Ω–∞ HSM** –ø–µ—Ä–µ–¥ —Ä–æ—Ç–∞—Ü–∏–µ–π
4. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ä–æ—Ç–∞—Ü–∏—é** —Å–Ω–∞—á–∞–ª–∞ –≤ staging –æ–∫—Ä—É–∂–µ–Ω–∏–∏
5. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ —Å–µ—Ä–≤–∏—Å** –≤–æ –≤—Ä–µ–º—è –∏ –ø–æ—Å–ª–µ —Ä–æ—Ç–∞—Ü–∏–∏
6. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ** –≤—Å–µ —Ä–æ—Ç–∞—Ü–∏–∏ –≤ –∂—É—Ä–Ω–∞–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
7. **–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ** —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –ø–µ—Ä–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
8. **–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ** –ª–æ–≥–∏ —Ä–æ—Ç–∞—Ü–∏–∏ –¥–ª—è –∞—É–¥–∏—Ç–∞

## –°–º. —Ç–∞–∫–∂–µ

- [SECURITY_AUDIT.md](SECURITY_AUDIT.md) - –û—Ç—á–µ—Ç –ø–æ –∞—É–¥–∏—Ç—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- [TECHNICAL_SPEC.md](TECHNICAL_SPEC.md) - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è
- PCI DSS v4.0 Requirement 3.6 - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–º–∏ –∫–ª—é—á–∞–º–∏
